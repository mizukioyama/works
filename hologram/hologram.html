<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>鉄球＋ガラス球＋虹色リング</title>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
  }
}
</script>
<style>
  html,body { height:100%; margin:0; background:#ffffff; } /* ←背景を真っ白に */
  canvas { display:block; width:100%; height:100%; }
</style>
</head>
<body>
<script type="module">
import * as THREE from "three";
import { RGBELoader } from "three/addons/loaders/RGBELoader.js";

// --- 基本 ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 0, 3.5);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.outputColorSpace = THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

// ライト
scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const dir = new THREE.DirectionalLight(0xffffff, 1.2);
dir.position.set(3,4,5);
scene.add(dir);

// --- CubeCamera (鉄球反射用) ---
const cubeRT = new THREE.WebGLCubeRenderTarget(256, {
  format: THREE.RGBAFormat,
  generateMipmaps: true,
  minFilter: THREE.LinearMipmapLinearFilter
});
const cubeCamera = new THREE.CubeCamera(0.1, 100, cubeRT);
scene.add(cubeCamera);

// --- ガラス球 (徐々に透明化) ---
const glassGeo = new THREE.SphereGeometry(1, 64, 64);
const glassMat = new THREE.MeshPhysicalMaterial({
  transmission: 0.6,
  thickness: 0.6,
  roughness: 0.3,
  ior: 1.5,
  clearcoat: 1.0,
  clearcoatRoughness: 0.2,
  transparent: true,
  opacity: 1.0
});
const glassMesh = new THREE.Mesh(glassGeo, glassMat);
scene.add(glassMesh);

// --- 鉄球 (メタリック反射) ---
const ironGeo = new THREE.SphereGeometry(0.5, 128, 128);
const ironMat = new THREE.MeshPhysicalMaterial({
  color: 0xffffff,
  metalness: 1.0,
  roughness: 0.05,
  envMap: cubeRT.texture,
  envMapIntensity: 2.0,
  clearcoat: 1.0,
  clearcoatRoughness: 0.05
});
const ironMesh = new THREE.Mesh(ironGeo, ironMat);
scene.add(ironMesh);

// --- 虹色リング (Additive, 鉄球の少し外側サイズ) ---
function createRainbowRing(inner, outer) {
  const geo = new THREE.RingGeometry(inner, outer, 256);
  const pos = geo.attributes.position;
  const colors = [];
  for (let i=0; i<pos.count; i++){
    const x = pos.getX(i), y = pos.getY(i);
    const ang = (Math.atan2(y,x) + Math.PI) / (2*Math.PI);
    const c = new THREE.Color();
    c.setHSL(ang, 1.0, 0.5);
    colors.push(c.r, c.g, c.b);
  }
  geo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));
  const mat = new THREE.MeshBasicMaterial({
    vertexColors: true,
    side: THREE.DoubleSide,
    transparent: true,
    opacity: 0.8,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });
  const mesh = new THREE.Mesh(geo, mat);
  mesh.rotation.x = Math.PI/2;
  return mesh;
}
const ring = createRainbowRing(0.7, 0.9);
scene.add(ring);

// --- オーラ (鉄球周囲のFresnel Glow) ---
const auraGeo = new THREE.SphereGeometry(0.65, 64, 64);
const auraMat = new THREE.ShaderMaterial({
  transparent: true,
  blending: THREE.AdditiveBlending,
  depthWrite: false,
  uniforms: { glowColor:{value:new THREE.Color(0xffffff)} },
  vertexShader: `
    varying vec3 vNormal;
    varying vec3 vPos;
    void main(){
      vNormal = normalize(normalMatrix*normal);
      vec4 wp = modelMatrix*vec4(position,1.0);
      vPos = wp.xyz;
      gl_Position = projectionMatrix*viewMatrix*wp;
    }`,
  fragmentShader: `
    varying vec3 vNormal;
    varying vec3 vPos;
    uniform vec3 glowColor;
    void main(){
      vec3 V = normalize(cameraPosition - vPos);
      float fres = pow(1.0 - max(dot(vNormal,V),0.0), 2.0);
      gl_FragColor = vec4(glowColor, fres*0.8);
    }`
});
const aura = new THREE.Mesh(auraGeo, auraMat);
scene.add(aura);

// --- 環境マップ ---
new RGBELoader()
  .setPath('https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/equirectangular/')
  .load('royal_esplanade_1k.hdr',(tex)=>{
    tex.mapping = THREE.EquirectangularReflectionMapping;
    scene.environment = tex;
  });

// --- 時間管理 ---
const start = Date.now();

// --- アニメーション ---
function animate(){
  requestAnimationFrame(animate);

  // CubeCamera更新
  ironMesh.visible=false;
  cubeCamera.update(renderer, scene);
  ironMesh.visible=true;

  const t = (Date.now()-start)/1000;

  // ガラスを透明化 (60秒)
  const p = Math.min(t/60,1.0);
  glassMat.opacity = 1.0-p;

  // 鉄球とリング回転
  ironMesh.rotation.y += 0.003;
  ring.rotation.z += 0.002;
  aura.rotation.y += 0.001;

  renderer.render(scene, camera);
}
animate();

// --- resize ---
addEventListener('resize',()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
